## 底层数据结构

### 简单动态字符串SDS

Redis 是用 C 语言写的，但是对于Redis的字符串，却不是 C 语言中的字符串（即以空字符’\0’结尾的字符数组），它是自己构建了一种名为 **简单动态字符串（simple dynamic string,SDS**）的抽象类型，并将 SDS 作为 Redis的默认字符串表示。

这是一种用于存储二进制数据的一种结构, 具有动态扩容的特点. 其实现位于`src/sds.h`与`src/sds.c`中。

- **SDS的总体概览**如下图:

![img](Redis.assets/db-redis-ds-x-3-17113307224361.png)

其中`sdshdr`是头部, `buf`是真实存储用户数据的地方. 另外注意, 从命名上能看出来, 这个数据结构除了能存储二进制数据, 显然是用于设计作为字符串使用的, 所以在buf中, 用户数据后总跟着一个\0. 即图中 `"数据" + "\0" `是为所谓的buf

使用`SDS`的好处

- **常数复杂度获取字符串长度**

- **杜绝缓存区溢出**
- **减少修改字符串的内存重新分配次数**
- **二进制安全**
- **兼容部分 C 字符串函数**

## 压缩列表-ZipList

> `ziplist`是为了提高存储效率而设计的一种**特殊编码的双向链表**。它可以存储字符串或者整数，存储整数时是采用整数的二进制而不是字符串形式存储。它能在**O(1)的时间复杂度下完成list两端的push和pop操作**。但是因为每次操作都需要重新分配`ziplist`的内存，所以实际复杂度和`ziplist`的内存使用量相关。

整个`ziplist`在内存中的存储格式如下：

![img](Redis.assets/db-redis-ds-x-6-17113308585614.png)

- `zlbytes`字段的类型是`uint32_t`, 这个字段中存储的是整个ziplist所占用的内存的字节数
- `zltail`字段的类型是`uint32_t`, 它指的是`ziplist`中最后一个entry的偏移量. 用于快速定位最后一个entry, 以快速完成pop等操作
- `zllen`字段的类型是uint16_t, 它指的是整个ziplit中entry的数量. 这个值只占2bytes（16位）: 如果ziplist中entry的数目小于65535(2的16次方), 那么该字段中存储的就是实际entry的值. 若等于或超过65535, 那么该字段的值固定为65535, 但实际数量需要一个个entry的去遍历所有entry才能得到.
- `zlend`是一个终止字节, 其值为全F, 即0xff. ziplist保证任何情况下, 一个entry的首字节都不会是255